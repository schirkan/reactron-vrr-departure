{"version":3,"file":"bundle.server.js","sources":["../src/server/services/PublicTransportService.ts","../src/server/index.ts"],"sourcesContent":["import { IReactronServiceContext } from '@schirkan/reactron-interfaces';\r\nimport * as request from 'request-promise-native';\r\nimport { IPublicTransportServiceOptions } from 'src/common/interfaces/IPublicTransportServiceOptions';\r\nimport { IPublicTransportService } from 'src/common/interfaces/IPublicTransportService';\r\nimport { IDepartureList, IDepartureResponse, IDepartureData } from 'src/common/interfaces/IDepartureList';\r\nimport { IStation } from 'src/common/interfaces/IStation';\r\nimport { IDepartureRequest } from 'src/common/interfaces/IDepartureRequest';\r\n\r\nconst baseUrl = 'https://haltestellenmonitor.vrr.de/backend/app.php/api/stations/';\r\n\r\ninterface ICacheItem {\r\n  timestamp: number;\r\n  result: Promise<any>;\r\n}\r\n\r\nexport class PublicTransportService implements IPublicTransportService {\r\n  private options: IPublicTransportServiceOptions;\r\n  private cache: { [url: string]: ICacheItem } = {};\r\n\r\n  constructor(private context: IReactronServiceContext) { }\r\n\r\n  public async setOptions(options: IPublicTransportServiceOptions): Promise<void> {\r\n    this.options = options;\r\n  }\r\n\r\n  public async getOptions(): Promise<Readonly<IPublicTransportServiceOptions>> {\r\n    return this.options;\r\n  }\r\n\r\n  public getDepartures(options: IDepartureRequest): Promise<IDepartureList> {\r\n    if (!options.distance || options.distance < 0) {\r\n      options.distance = 0;\r\n    }\r\n    if (!options.platformVisibility || options.platformVisibility < 0) {\r\n      options.platformVisibility = 1;\r\n    }\r\n    if (!options.rowCount || options.rowCount < 1) {\r\n      options.rowCount = 6;\r\n    }\r\n    if (!options.transport) {\r\n      options.transport = [0, 1, 2, 3, 4, 5];\r\n    }\r\n    const url = baseUrl + 'table';\r\n    const cacheKey = url + JSON.stringify(options);\r\n\r\n    const result = this.getOrCreate(cacheKey, () => {\r\n      const requestOptions: request.RequestPromiseOptions = {\r\n        headers: { cookie: 'vrr-ef-lb=1530374336.20480.0000' },\r\n        body:\r\n          'table[departure][stationName]=' + encodeURIComponent(options.station.name) +\r\n          '&table[departure][transport]=' + options.transport.join(',') +\r\n          '&table[departure][rowCount]=' + options.rowCount +\r\n          '&table[sortBy]=0' +\r\n          '&table[departure][platformVisibility]=' + options.platformVisibility +\r\n          '&table[departure][distance]=' + options.distance +\r\n          '&table[departure][stationId]=' + options.station.id\r\n      };\r\n      return this.getResponseInternal('post', url, requestOptions, PublicTransportService.mapToDepartureList);\r\n    });\r\n    return result;\r\n  }\r\n\r\n  public getStations(query: string): Promise<IStation[]> {\r\n    const url = baseUrl + 'search?query=' + encodeURI(query);\r\n    const result = this.getOrCreate<IStation[]>(url, () => {\r\n      return this.getResponseInternal('get', url, {}, PublicTransportService.mapToStationList);\r\n    });\r\n    return result;\r\n  }\r\n\r\n  private async getResponseInternal<TResponse>(method: 'get' | 'post', url: string,\r\n    requestOptions: request.RequestPromiseOptions, mapper: (response: any) => TResponse): Promise<TResponse> {\r\n    this.context.log.debug('fetch', url);\r\n    requestOptions = { ...requestOptions, json: true, rejectUnauthorized: false, resolveWithFullResponse: true };\r\n\r\n    try {\r\n      let response: request.FullResponse | undefined;\r\n      switch (method) {\r\n        case \"get\":\r\n          response = await request.get(url, requestOptions);\r\n          break;\r\n        case \"post\":\r\n          requestOptions.headers![\"Content-Type\"] = \"application/x-www-form-urlencoded\";\r\n          response = await request.post(url, requestOptions);\r\n          break;\r\n      }\r\n      if (!response) {\r\n        throw new Error('response is undefined');\r\n      }\r\n      if (response.statusCode !== 200) {\r\n        this.context.log.error(response.statusMessage, response.body);\r\n        throw new Error(response.statusMessage);\r\n      }\r\n      this.context.log.debug(response.body);\r\n      return mapper(response.body);\r\n    } catch (error) {\r\n      this.context.log.error(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private async getOrCreate<TResponse>(key: string, creator: () => Promise<TResponse>): Promise<TResponse> {\r\n    const now = Date.now();\r\n    const validCacheTime = now - (this.options.cacheDuration * 60 * 1000);\r\n\r\n    // check timestamp\r\n    if (this.cache[key] && this.cache[key].timestamp < validCacheTime) {\r\n      delete (this.cache[key]);\r\n    }\r\n\r\n    if (!this.cache[key]) {\r\n      this.cache[key] = {\r\n        timestamp: now,\r\n        result: creator()\r\n      };\r\n    } else {\r\n      this.context.log.debug('cache hit');\r\n    }\r\n\r\n    return this.cache[key].result;\r\n  }\r\n\r\n  private static mapToDepartureList(response: any): IDepartureList {\r\n    const result: IDepartureList = {\r\n      departures: (response.departureData as IDepartureResponse[]).map(item => ({\r\n        departureTimestamp: item.fullTime,\r\n        originalDepartureTimestamp: item.orgFullTime,\r\n        name: item.name,\r\n        lineNumber: item.lineNumber,\r\n        subname: item.subname,\r\n        direction: item.direction,\r\n        directionCode: item.directionCode,\r\n        route: item.route,\r\n        type: item.type,\r\n        platform: item.platform,\r\n        delay: +item.delay,\r\n      } as IDepartureData)),\r\n      stationInfo: response.stationInfo,\r\n      stationName: response.stationName,\r\n    };\r\n    return result;\r\n  }\r\n\r\n  private static mapToStationList(response: any): IStation[] {\r\n    const suggestions: { data: string, value: string }[] = response.suggestions;\r\n    const result: IStation[] = suggestions.map(item => ({\r\n      id: item.data,\r\n      name: item.value,\r\n    } as IStation));\r\n    return result;\r\n  }\r\n}","import { IReactronServiceDefinition } from '@schirkan/reactron-interfaces';\r\nimport { PublicTransportService } from './services/PublicTransportService';\r\n\r\n// export interfaces\r\nexport * from '../common/interfaces/IDepartureList';\r\nexport * from '../common/interfaces/IPublicTransportService';\r\nexport * from '../common/interfaces/IPublicTransportServiceOptions';\r\n\r\n// export reactron service definition\r\nexport const services: IReactronServiceDefinition[] = [{\r\n  description: 'Service for public transport in germany',\r\n  displayName: 'Public transport information service',\r\n  fields: [{\r\n    defaultValue: 5,\r\n    description: 'Cache duration in minutes',\r\n    displayName: 'Cache duration (min)',\r\n    name: 'cacheDuration',\r\n    valueType: 'number',\r\n    minValue: 0,\r\n    maxValue: 60,\r\n    stepSize: 1\r\n  }],\r\n  name: 'PublicTransportService',\r\n  service: PublicTransportService\r\n}];"],"names":["request.get","request.post"],"mappings":"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"}